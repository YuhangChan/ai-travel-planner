# 🛠️ 高德地图显示问题 Debug 操作步骤

## 📋 前置准备

1. **确保已配置环境变量**
   - 打开 `.env.local` 文件
   - 确认以下配置存在且正确：
     ```
     VITE_AMAP_API_KEY=你的高德地图Key
     VITE_AMAP_SECURITY_CODE=你的高德地图安全密钥
     ```

2. **启动开发服务器**
   ```bash
   npm run dev
   ```

---

## 🔍 Debug 步骤

### 步骤 1: 使用调试工具页面进行基础测试

1. **访问调试页面**
   - 在浏览器中打开: `http://localhost:5173/debug`
   - 无需登录即可访问

2. **检查API加载状态**
   - 查看页面顶部的状态标签：
     - ✅ `window.AMap: 已加载` - API 加载成功
     - ❌ `window.AMap: 未加载` - API 加载失败
   - 如果未加载，检查：
     - `index.html` 中的 `<script>` 标签
     - 浏览器 Network 面板是否有加载错误
     - Console 面板是否有 API Key 错误

3. **测试1: 手动添加标记**
   - 点击 "添加随机测试标记" 按钮
   - 查看地图是否显示标记
   - **如果成功**: 说明地图API工作正常，问题在数据源
   - **如果失败**: 查看Console日志，检查API配置

4. **测试2: 地点搜索**
   - 在搜索框输入 "天安门"
   - 点击 "搜索地点"
   - 查看Console日志输出：
     ```
     🧪 测试2: 地点搜索 (PlaceSearch)
       搜索关键词: 天安门
       搜索状态: complete
       找到 X 个地点:
         [0] 天安门
             地址: xxx
             坐标: [116.xxx, 39.xxx]
     ```
   - **重点检查**:
     - 坐标格式是否正确 `[经度, 纬度]`
     - 坐标范围是否合理（中国境内）

5. **测试3: 地理编码**
   - 输入地址 "北京市朝阳区"
   - 点击 "地理编码"
   - 查看是否能成功转换为坐标
   - **用途**: 验证地址到坐标的转换功能是否正常

---

### 步骤 2: 检查实际行程数据

1. **创建或打开一个旅行计划**
   - 登录后创建新计划，或打开已有计划
   - 进入计划详情页面

2. **打开浏览器开发者工具** (F12)
   - 切换到 "Console" 标签

3. **查看地图初始化日志**
   - 应该看到类似以下的日志分组：
     ```
     🗺️ 高德地图初始化开始
       步骤1: 检查高德地图API加载状态
         ✅ 高德地图API加载成功
       步骤2: 检查行程数据
         总天数: X
         总活动数: X
         总住宿数: X
       步骤3: 创建地图实例
         ✅ 地图实例创建成功
       步骤4: 开始添加标记点
         📍 处理活动标记:
           [0-0] 景点名称:
             地点信息: {name: "...", latitude: XX, longitude: XX}
             经度: XX.XXXX (✅)
             纬度: XX.XXXX (✅)
             坐标范围检查: ✅ 在中国境内
             ✅ 标记添加成功
       步骤5: 标记添加统计
         ✅ 成功添加: X 个标记
         ❌ 失败/跳过: X 个标记
     ```

4. **分析问题**

   **情况A: 坐标缺失**
   ```
   ⚠️ 坐标缺失，跳过该活动
   ```
   - **原因**: LLM 未生成经纬度
   - **解决**: 需要改进 LLM Prompt 或使用地理编码补全

   **情况B: 坐标超出范围**
   ```
   ❌ 超出中国范围
   ```
   - **原因**: LLM 生成了错误的坐标
   - **解决**: 需要使用高德PlaceSearch重新获取坐标

   **情况C: 标记添加失败**
   ```
   ❌ 标记添加失败: [错误信息]
   ```
   - **原因**: 坐标格式错误或其他API问题
   - **解决**: 检查错误详情，验证坐标格式

   **情况D: 成功添加但地图空白**
   ```
   ✅ 成功添加: 5 个标记
   ⚠️ 没有有效标记，地图保持默认视野
   ```
   - **原因**: setFitView 未正常工作
   - **解决**: 手动缩放地图查看

---

### 步骤 3: 验证 LLM 生成的数据质量

1. **查看完整的计划数据**
   - 在Console中输入:
     ```javascript
     // 获取当前页面的plan数据
     window.__plan__ // (如果有暴露)

     // 或者在代码中添加
     console.log('完整计划数据:', JSON.stringify(plan, null, 2));
     ```

2. **检查数据结构**
   ```json
   {
     "itinerary": {
       "days": [
         {
           "day": 1,
           "activities": [
             {
               "name": "景点名称",
               "location": {
                 "name": "地点名称",
                 "address": "详细地址",
                 "latitude": 39.90923,    // ← 检查是否存在
                 "longitude": 116.397428  // ← 检查是否存在
               }
             }
           ]
         }
       ]
     }
   }
   ```

3. **问题诊断**

   | 问题现象 | 可能原因 | Debug方法 |
   |---------|---------|----------|
   | `latitude/longitude` 不存在 | LLM未生成坐标 | 检查LLM的prompt和response |
   | 坐标值为 0 或 null | LLM生成失败 | 需要改进prompt或使用默认值 |
   | 坐标在国外 | LLM理解错误 | 使用PlaceSearch重新获取 |
   | 地点名称不准确 | LLM生成的名称不规范 | 使用模糊搜索匹配 |

---

### 步骤 4: 手动测试坐标修复

如果发现坐标缺失或错误，可以在Console中手动测试修复：

```javascript
// 1. 测试地点搜索
const placeSearch = new window.AMap.PlaceSearch({
  city: '北京',
  pageSize: 5
});

placeSearch.search('天安门', (status, result) => {
  if (status === 'complete' && result.poiList) {
    const poi = result.poiList.pois[0];
    console.log('找到地点:', poi.name);
    console.log('坐标:', poi.location.lng, poi.location.lat);
  }
});

// 2. 测试地理编码
const geocoder = new window.AMap.Geocoder({
  city: '北京'
});

geocoder.getLocation('北京市朝阳区', (status, result) => {
  if (status === 'complete' && result.geocodes) {
    const location = result.geocodes[0].location;
    console.log('编码结果:', location.lng, location.lat);
  }
});
```

---

### 步骤 5: 对比测试

1. **在调试页面搜索LLM生成的地点名称**
   - 复制行程中的地点名称
   - 在 `/debug` 页面的搜索框中搜索
   - 查看是否能找到匹配结果

2. **对比坐标**
   - 比较调试工具搜索出的坐标
   - 和LLM生成的坐标
   - 检查是否一致

3. **测试不同的搜索关键词**
   - 完整名称: "北京市天安门广场"
   - 简化名称: "天安门"
   - 城市+地点: "北京 天安门"
   - 记录哪种格式搜索结果最准确

---

## 🎯 常见问题和解决方案

### Q1: 地图完全不显示
**Debug步骤**:
1. 检查 `window.AMap` 是否存在
2. 检查Network面板，API脚本是否加载
3. 检查Console是否有 API Key 错误
4. 验证 `.env.local` 配置是否正确

### Q2: 地图显示但没有标记
**Debug步骤**:
1. 查看Console日志，确认有数据
2. 检查 "成功添加" 的标记数量
3. 手动缩放地图，查看是否标记在视野外
4. 在 `/debug` 页面测试手动添加标记

### Q3: 部分标记显示，部分不显示
**Debug步骤**:
1. 查看 "失败/跳过" 的数量
2. 检查哪些活动缺少坐标
3. 使用PlaceSearch搜索缺失的地点
4. 记录问题地点的名称模式

### Q4: LLM 总是不生成坐标
**解决方案**:
- 需要修改 `src/services/llm.ts` 的 prompt
- 在prompt中明确要求提供经纬度
- 或者在前端添加坐标补全逻辑

---

## 📊 Debug 检查清单

使用以下清单系统化检查问题：

- [ ] **API 加载**
  - [ ] `window.AMap` 存在
  - [ ] Network中API脚本加载成功
  - [ ] 没有API Key错误

- [ ] **地图实例**
  - [ ] 地图容器正确渲染
  - [ ] 地图实例创建成功
  - [ ] 可以手动拖动、缩放地图

- [ ] **数据源**
  - [ ] `plan.itinerary` 存在
  - [ ] `days` 数组不为空
  - [ ] `activities` 数组不为空

- [ ] **坐标数据**
  - [ ] `latitude` 字段存在
  - [ ] `longitude` 字段存在
  - [ ] 坐标值不为 0 或 null
  - [ ] 坐标在合理范围内

- [ ] **标记添加**
  - [ ] 至少有一个标记成功添加
  - [ ] `setFitView` 正常工作
  - [ ] 标记可以点击查看信息

- [ ] **高德API功能**
  - [ ] PlaceSearch 正常工作
  - [ ] Geocoder 正常工作
  - [ ] 手动添加标记成功

---

## 🚀 下一步行动建议

根据 debug 结果，可能需要：

1. **如果坐标缺失**:
   - 改进 LLM prompt
   - 添加前端坐标补全功能（使用PlaceSearch或Geocoder）

2. **如果坐标错误**:
   - 使用PlaceSearch验证地点
   - 实现坐标校验和修正逻辑

3. **如果地点名称不准确**:
   - 实现模糊搜索匹配
   - 添加地点选择确认流程

4. **如果API配置问题**:
   - 检查高德开放平台控制台
   - 验证Key和安全密钥的正确性
   - 检查域名白名单配置

---

## 💡 调试技巧

1. **使用Console分组查看日志**
   - 所有地图相关日志都在分组中
   - 点击折叠/展开查看详情

2. **保存问题数据**
   ```javascript
   // 保存完整的plan数据用于分析
   copy(JSON.stringify(plan, null, 2));
   ```

3. **对比正常和异常的数据**
   - 记录成功显示的地点坐标格式
   - 记录失败的地点名称特征

4. **使用Network面板**
   - 查看是否有API请求失败
   - 检查响应内容是否正常

---

## 📝 问题记录模板

记录发现的问题，便于后续修复：

```markdown
### 问题描述
- 地点名称: [具体名称]
- 问题现象: [坐标缺失/坐标错误/搜索不到]
- LLM生成的坐标: [具体值]
- PlaceSearch结果: [搜索结果]

### 重现步骤
1. ...
2. ...

### Console日志
[粘贴相关日志]

### 解决方案
[建议的修复方法]
```

---

**祝调试顺利！如有问题，请查看Console的详细日志。** 🎉
